# ê¸°ë¢° ë ˆì´ë¸”ë§ í”„ë¡œì íŠ¸ - ë¹ ë¥¸ ì‹œì‘ ê°€ì´ë“œ

## ğŸ“‹ ê°œìš”

ì‚¬ì´ë“œ ìŠ¤ìº” ì†Œë‚˜ ë°ì´í„°ì—ì„œ ê¸°ë¢°ë¥¼ ë ˆì´ë¸”ë§í•˜ëŠ” ì™„ì „í•œ ì›Œí¬í”Œë¡œìš°ì…ë‹ˆë‹¤.

**ì£¼ìš” ê¸°ëŠ¥**:
- âœ… NPY ê°•ë„ ë°ì´í„° â†’ BMP ì‹œê°í™” ë³€í™˜ (ë°©í–¥ ë³´ì¡´)
- âœ… ì¸í„°ë™í‹°ë¸Œ ë°”ìš´ë”© ë°•ìŠ¤ ê·¸ë¦¬ê¸°
- âœ… BMP ì¢Œí‘œ â†’ NPY ì¢Œí‘œ ìë™ ë³€í™˜ (6.25ë°° ìŠ¤ì¼€ì¼ë§)
- âœ… ê²€ì¦ ë° ì‹œê°í™”
- âœ… ìƒ˜í”Œë§ ë° ë°ì´í„° ì¦ê°• (9ê°€ì§€ ê¸°ë²•)

---

## ğŸš€ ë¹ ë¥¸ ì‹œì‘

### 1. ì„¤ì¹˜

```bash
cd mine_labeling_project
pip install -r requirements.txt
```

### 2. ê²€ì¦ëœ ë°ì´í„° ì‚¬ìš© (ì´ë¯¸ ë ˆì´ë¸”ë§ ì™„ë£Œ)

```python
from mine_labeling.utils import load_npz_data

# ê²€ì¦ëœ ë ˆì´ë¸” ë°ì´í„° ë¡œë“œ
data = load_npz_data('verified_data/flipped_20251104/flipped_labeled_intensity_data.npz')

print(f"ê°•ë„ ë°ì´í„°: {data['intensity'].shape}")  # (5137, 6400)
print(f"ë ˆì´ë¸” ë§ˆìŠ¤í¬: {data['labels'].shape}")    # (5137, 6400)
print(f"ê¸°ë¢° ê°œìˆ˜: {len(data['metadata'])}")        # 25ê°œ
```

### 3. ìƒˆë¡œìš´ ë°ì´í„° ë ˆì´ë¸”ë§

```bash
# ì „ì²´ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰
python scripts/interactive_labeling_workflow.py <your_npy_file.npy>
```

---

## ğŸ“– ìƒì„¸ ì›Œí¬í”Œë¡œìš°

### ì›Œí¬í”Œë¡œìš° 1: ê²€ì¦ëœ ë°ì´í„°ë¡œ ìƒ˜í”Œë§ + ì¦ê°•

```bash
# ì „ì²´ íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ (ìƒ˜í”Œë§ + ì¦ê°•)
python scripts/run_full_pipeline.py
```

**ê²°ê³¼**:
- ê¸°ë¢° ìƒ˜í”Œ: 25ê°œ
- ë°°ê²½ ìƒ˜í”Œ: 125ê°œ (1:5 ë¹„ìœ¨)
- ì¦ê°• ìƒ˜í”Œ: 1,350ê°œ (9ê°€ì§€ ê¸°ë²•)

**ì¶œë ¥ í´ë”**:
```
data/processed/
â”œâ”€â”€ sampled/
â”‚   â”œâ”€â”€ mines/          # ê¸°ë¢° ìƒ˜í”Œ (25ê°œ)
â”‚   â””â”€â”€ background/     # ë°°ê²½ ìƒ˜í”Œ (125ê°œ)
â””â”€â”€ augmented/
    â”œâ”€â”€ mines/          # ì¦ê°•ëœ ê¸°ë¢° (225ê°œ)
    â””â”€â”€ background/     # ì¦ê°•ëœ ë°°ê²½ (1125ê°œ)
```

### ì›Œí¬í”Œë¡œìš° 2: ìƒˆë¡œìš´ NPY ë°ì´í„° ë ˆì´ë¸”ë§

#### 2-1. NPY â†’ BMP ë³€í™˜

```python
from mine_labeling.visualization import NpyToBmpConverter
import numpy as np

# NPY ë¡œë“œ
npy_data = np.load('your_intensity_data.npy')

# BMP ë³€í™˜ (ì‹œê°í™”ìš©)
converter = NpyToBmpConverter(
    target_width=1024,    # 6400 â†’ 1024 (6.25ë°° ì¶•ì†Œ)
    apply_clahe=True,     # ëŒ€ë¹„ í–¥ìƒ
    clip_limit=2.0
)

bmp_image = converter.convert_to_bmp(
    npy_data,
    output_path='data/visualization/intensity.bmp'
)
```

**ì¤‘ìš”**:
- âœ… ë°©í–¥ ë³´ì¡´ (í”Œë¦½ ì—†ìŒ, `origin='upper'`)
- âœ… Xì¶• 6.25ë°° ì¶•ì†Œ (6400 â†’ 1024)
- âœ… Yì¶• ìœ ì§€ (5137 â†’ 5137)

#### 2-2. ì¸í„°ë™í‹°ë¸Œ ë°”ìš´ë”© ë°•ìŠ¤ ê·¸ë¦¬ê¸°

```bash
# ì¸í„°ë™í‹°ë¸Œ ë ˆì´ë¸”ë§ ë„êµ¬ ì‹¤í–‰
python scripts/interactive_labeling_workflow.py data/your_intensity.npy
```

**ì¡°ì‘ë²•**:
- **ì™¼ìª½ í´ë¦­ + ë“œë˜ê·¸**: ë°”ìš´ë”© ë°•ìŠ¤ ê·¸ë¦¬ê¸°
- **ì˜¤ë¥¸ìª½ í´ë¦­**: ê°€ì¥ ê°€ê¹Œìš´ ë°•ìŠ¤ ì‚­ì œ
- **'s' í‚¤**: ì €ì¥ (XML + JSON)
- **'q' í‚¤**: ì €ì¥ ì—†ì´ ì¢…ë£Œ
- **'Esc' í‚¤**: í˜„ì¬ ë°•ìŠ¤ ì·¨ì†Œ

#### 2-3. ì¢Œí‘œ ìë™ ë³€í™˜

ë ˆì´ë¸”ë§ ì›Œí¬í”Œë¡œìš°ê°€ ìë™ìœ¼ë¡œ ìˆ˜í–‰:
- BMP ì¢Œí‘œ (1024Ã—5137) â†’ NPY ì¢Œí‘œ (6400Ã—5137)
- ìŠ¤ì¼€ì¼ íŒ©í„°: 6.25ë°°
- ê³µì‹: `X_npy = X_bmp Ã— 6.25`, `Y_npy = Y_bmp`

**ì €ì¥ë˜ëŠ” íŒŒì¼**:
```
data/interactive_labeling/
â”œâ”€â”€ intensity_visualization.bmp          # ì‹œê°í™” BMP
â”œâ”€â”€ intensity_visualization.xml          # PASCAL VOC XML (BMP ì¢Œí‘œ)
â”œâ”€â”€ intensity_visualization.json         # JSON (BMP ì¢Œí‘œ)
â””â”€â”€ mapped_annotations.json              # ë§¤í•‘ëœ NPY ì¢Œí‘œ
```

---

## ğŸ“Š ë°ì´í„° í˜•ì‹

### NPZ íŒŒì¼ êµ¬ì¡°

```python
{
    'intensity': (H, W) float32,  # ì •ê·œí™”ëœ ê°•ë„ [0, 1]
    'labels': (H, W) uint8,       # ì´ì§„ ë§ˆìŠ¤í¬ (0=ë°°ê²½, 1=ê¸°ë¢°)
    'metadata': JSON string        # ì£¼ì„ (ì¢Œí‘œ + ë©”íƒ€ë°ì´í„°)
}
```

### XML í˜•ì‹ (PASCAL VOC)

```xml
<annotation>
    <size>
        <width>6400</width>      <!-- NPY ì¢Œí‘œìš© -->
        <height>5137</height>
    </size>
    <object>
        <name>mine</name>
        <bndbox>
            <xmin>4868</xmin>
            <ymin>1070</ymin>
            <xmax>5187</xmax>
            <ymax>1119</ymax>
        </bndbox>
    </object>
</annotation>
```

---

## ğŸ”§ ì£¼ìš” ëª¨ë“ˆ

### 1. ì¢Œí‘œ ë³€í™˜

```python
from mine_labeling.labeling import CoordinateMapper

mapper = CoordinateMapper(
    bmp_width=1024,
    bmp_height=5137,
    npy_width=6400,
    npy_height=5137,
    apply_y_flip=True  # ê¸°ì¡´ BMP ë°ì´í„°ìš©
)

# ì¢Œí‘œ ë³€í™˜
npy_bbox = mapper.map_bbox(bmp_bbox)
```

### 2. ë ˆì´ë¸” ìƒì„±

```python
from mine_labeling.labeling import LabelGenerator

generator = LabelGenerator(
    height=5137,
    width=6400,
    background_value=0,
    mine_value=1
)

# ì´ì§„ ë§ˆìŠ¤í¬ ìƒì„±
label_mask = generator.create_binary_mask(annotations)
```

### 3. ìƒ˜í”Œë§

```python
from mine_labeling.sampling import MineSampler, BackgroundSampler

# ê¸°ë¢° ìƒ˜í”Œë§
mine_sampler = MineSampler(patch_size=128, center_crop=True)
mine_samples = mine_sampler.extract_all_mines(intensity, labels, annotations)

# ë°°ê²½ ìƒ˜í”Œë§
bg_sampler = BackgroundSampler(
    patch_size=128,
    num_samples=125,
    min_distance_from_mine=50
)
bg_samples = bg_sampler.extract_background_samples(intensity, labels, annotations)
```

### 4. ë°ì´í„° ì¦ê°•

```python
from mine_labeling.augmentation import Augmentor

augmentor = Augmentor(augmentation_factor=9)

# ëª¨ë“  ì¦ê°• ì ìš©
augmented = augmentor.augment_all(intensity_patch, label_patch)
```

---

## âš™ï¸ ì„¤ì •

### ê¸°ë³¸ ì„¤ì • íŒŒì¼: `config/default_config.yaml`

```yaml
coordinate_mapping:
  bmp_width: 1024
  bmp_height: 5137
  npy_width: 6400
  npy_height: 5137
  apply_y_flip: true     # ê¸°ì¡´ BMP: true, ìƒˆ ì¶”ì¶œ: false

sampling:
  mine_samples: 25
  background_samples: 125
  patch_size: 128

augmentation:
  augmentation_factor: 9
  techniques:
    horizontal_flip:
      enabled: true
    vertical_flip:
      enabled: true
    # ... ë‚˜ë¨¸ì§€ 7ê°€ì§€ ê¸°ë²•
```

### ì»¤ìŠ¤í…€ ì„¤ì •

```bash
# ì»¤ìŠ¤í…€ ì„¤ì •ìœ¼ë¡œ íŒŒì´í”„ë¼ì¸ ì‹¤í–‰
python scripts/run_full_pipeline.py --config config/my_config.yaml
```

---

## ğŸ“ PyTorch ë°ì´í„°ì…‹ ì˜ˆì œ

```python
import torch
from torch.utils.data import Dataset, DataLoader
from mine_labeling.utils import load_npz_data

class MineDataset(Dataset):
    def __init__(self, npz_path):
        data = load_npz_data(npz_path)
        self.intensity = torch.FloatTensor(data['intensity'])
        self.labels = torch.LongTensor(data['labels'])

    def __len__(self):
        return self.intensity.shape[0]

    def __getitem__(self, idx):
        return self.intensity[idx], self.labels[idx]

# ì‚¬ìš©
dataset = MineDataset('verified_data/flipped_20251104/flipped_labeled_intensity_data.npz')
dataloader = DataLoader(dataset, batch_size=32, shuffle=True)
```

---

## â“ ìì£¼ ë¬»ëŠ” ì§ˆë¬¸

### Q1: Yì¶• í”Œë¦½ì´ ì–¸ì œ í•„ìš”í•œê°€ìš”?

**A**:
- **ê¸°ì¡´ BMP ë°ì´í„°**: `apply_y_flip: true` (ì´ë¯¸ í”Œë¦½ë¨)
- **ìƒˆë¡œìš´ XTF ì¶”ì¶œ**: `apply_y_flip: false` (ì›ë³¸ ë°©í–¥ ìœ ì§€)

### Q2: ì¢Œí‘œ ë³€í™˜ ê³µì‹ì€?

**A**:
```
Xì¶•: X_npy = X_bmp Ã— 6.25 (1024 â†’ 6400)
Yì¶•: Y_npy = Y_bmp (5137 ìœ ì§€)

Yì¶• í”Œë¦½ ì‹œ: Y_npy = (5137 - 1) - Y_bmp
```

### Q3: ê²€ì¦ëœ ë°ì´í„°ë¥¼ ì‚¬ìš©í•˜ë ¤ë©´?

**A**:
```python
data = load_npz_data('verified_data/flipped_20251104/flipped_labeled_intensity_data.npz')
```
ì´ë¯¸ 25ê°œ ê¸°ë¢°ê°€ ë ˆì´ë¸”ë§ë˜ì–´ ê²€ì¦ ì™„ë£Œëœ ë°ì´í„°ì…ë‹ˆë‹¤.

### Q4: ìƒˆ ë°ì´í„°ë¥¼ ë ˆì´ë¸”ë§í•˜ë ¤ë©´?

**A**:
```bash
python scripts/interactive_labeling_workflow.py your_data.npy
```

---

## ğŸ“‚ í”„ë¡œì íŠ¸ êµ¬ì¡°

```
mine_labeling_project/
â”œâ”€â”€ config/                      # ì„¤ì • íŒŒì¼
â”‚   â”œâ”€â”€ default_config.yaml
â”‚   â””â”€â”€ example_config.yaml
â”œâ”€â”€ src/mine_labeling/          # í•µì‹¬ ëª¨ë“ˆ
â”‚   â”œâ”€â”€ visualization/          # NPYâ†”BMP ë³€í™˜, ì¸í„°ë™í‹°ë¸Œ ë„êµ¬
â”‚   â”œâ”€â”€ labeling/              # ì¢Œí‘œ ë§¤í•‘, ë ˆì´ë¸” ìƒì„±
â”‚   â”œâ”€â”€ sampling/              # ê¸°ë¢°/ë°°ê²½ ìƒ˜í”Œë§
â”‚   â”œâ”€â”€ augmentation/          # ë°ì´í„° ì¦ê°•
â”‚   â””â”€â”€ validation/            # ê²€ì¦
â”œâ”€â”€ scripts/                    # ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸
â”‚   â”œâ”€â”€ run_full_pipeline.py           # ì „ì²´ íŒŒì´í”„ë¼ì¸
â”‚   â”œâ”€â”€ interactive_labeling_workflow.py  # ì¸í„°ë™í‹°ë¸Œ ë ˆì´ë¸”ë§
â”‚   â””â”€â”€ convert_json_to_xml.py         # JSONâ†’XML ë³€í™˜
â”œâ”€â”€ verified_data/             # ê²€ì¦ëœ ë°ì´í„°
â”‚   â””â”€â”€ flipped_20251104/
â”‚       â”œâ”€â”€ flipped_labeled_intensity_data.npz  # ì™„ì„±ëœ ë ˆì´ë¸” ë°ì´í„°
â”‚       â””â”€â”€ flipped_npy_annotations.xml         # NPY ì¢Œí‘œ XML
â””â”€â”€ docs/                       # ë¬¸ì„œ
    â””â”€â”€ ë¹ ë¥¸ì‹œì‘_ê°€ì´ë“œ.md (ì´ íŒŒì¼)
```

---

## ğŸ¯ ë‹¤ìŒ ë‹¨ê³„

1. **ê²€ì¦ëœ ë°ì´í„°ë¡œ ì‹œì‘**:
   ```bash
   python scripts/run_full_pipeline.py
   ```

2. **ìƒˆ ë°ì´í„° ë ˆì´ë¸”ë§**:
   ```bash
   python scripts/interactive_labeling_workflow.py your_data.npy
   ```

3. **ëª¨ë¸ í•™ìŠµ ì¤€ë¹„**:
   - `data/processed/augmented/` ì—ì„œ ì¦ê°•ëœ ë°ì´í„° ì‚¬ìš©
   - PyTorch/TensorFlow ë°ì´í„°ì…‹ ìƒì„±
   - í•™ìŠµ ì‹œì‘!

---

**ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸**: 2025-11-04
**ì‘ì„±ì**: Mine Detection Team
